# MFP vs MFP2 Cox Model Analysis Comparison

This repository contains R scripts designed to compare the results of Cox proportional hazards models on large datasets from SEER data. The models are fitted using the `mfp` (Multivariable Fractional Polynomials) package and the newer `mfp2` package. The analysis focuses on applying these packages to various subsets of a main dataset (`dat_ida.csv`) and comparing the resulting model specifications.

## Overview

The workflow involves:
1.  Running models on multiple data subsets using the `mfp` package and saving the results and the exact data subsets used.
2.  Running the same model specifications on the *exact same* data subsets using the `mfp2` package.
3.  Performing a direct comparison between `mfp` and `mfp2` for a specific model and data subset.

*(Note: An additional script, `new analysis mfp2.R`, is included which performs the `mfp2` analysis but generates its own data subsets instead of loading the pre-saved ones. This might be useful for standalone `mfp2` testing but is not part of the primary comparison workflow using identical data.)*

## Scripts

Here's a breakdown of the R scripts included in this repository:

### 1. `New analysis mfp.R`

* **Purpose**: This script serves as the starting point. It loads the main dataset (`data/dat_ida.csv`), performs initial preprocessing, creates multiple data subsets of varying sizes, and fits Cox models using the `mfp` package on each subset. It runs models based on both AIC-like (select=0.157) and BIC-like (select=pchisq(log(events),1)) criteria.
* **Key Actions**:
    * Loads and preprocesses `data/dat_ida.csv`.
    * Generates multiple data subsets (e.g., `dat_10K_1`, `dat_50K_2`, etc.) and includes the full dataset (`dat_Full`).
    * Fits `mfp` Cox models for each subset using AIC and BIC selection criteria.
    * Extracts model summaries (FP powers, categorical variable selection).
    * Generates auxiliary plots (correlation, example functional forms, example prediction comparisons).
* **Outputs Saved**:
    * `dat_subsets_list.rds`: An R data file containing the list of all generated data subsets. **This is crucial for the subsequent `mfp2` comparison script.**
    * `mfp_aic_fp_powers_summary.csv`: Summary of selected fractional polynomial powers for AIC models.
    * `mfp_aic_categorical_selection_summary.csv`: Summary of selected categorical variables for AIC models.
    * `mfp_bic_fp_powers_summary.csv`: Summary of selected fractional polynomial powers for BIC models.
    * `mfp_bic_categorical_selection_summary.csv`: Summary of selected categorical variables for BIC models.
    * `correlation_plot_spearman.png`: Spearman correlation plot of variables.
    * `functional_forms_AgeDgc_AIC.png`: Example plot of the functional form for AgeDgc from AIC models.
    * `prediction_scatter_*.png` / `prediction_bland_altman_*.png`: Example prediction comparison plots (if that section is run).

### 2. `MFP2 analysis on same data as MFP.R`

* **Purpose**: This script replicates the analysis performed by `New analysis mfp.R`, but uses the `mfp2` package instead. Crucially, **it loads the `dat_subsets_list.rds` file generated by the first script** to ensure that `mfp2` models are fitted on the *exact same data* as the `mfp` models.
* **Key Actions**:
    * Loads the `dat_subsets_list.rds` file.
    * Fits `mfp2` Cox models for each loaded subset using AIC-like (select=0.157) and BIC-like (select=pchisq(log(events),1)) criteria.
    * Extracts model summaries (FP powers/DF, categorical variable selection) using a dedicated function.
* **Outputs Saved**:
    * `mfp2_aic_fp_powers_summary_loaded.csv`: Summary of selected FP powers/DF for AIC models (using loaded data).
    * `mfp2_aic_categorical_selection_summary_loaded.csv`: Summary of selected categorical variables for AIC models (using loaded data).
    * `mfp2_bic_fp_powers_summary_loaded.csv`: Summary of selected FP powers/DF for BIC models (using loaded data).
    * `mfp2_bic_categorical_selection_summary_loaded.csv`: Summary of selected categorical variables for BIC models (using loaded data).

### 3. `Compare mfp vs mfp2.R`

* **Purpose**: This script performs a direct, side-by-side comparison of the model fitting process and results between `mfp` and `mfp2` for a *single*, specific data subset (e.g., `dat_10K_1`). It carefully manages package loading/unloading to avoid conflicts between `mfp::fp()` and `mfp2::fp()`.
* **Key Actions**:
    * Loads the `dat_subsets_list.rds` file.
    * Selects a specific data subset (e.g., `dat_10K_1`).
    * Fits an AIC-like and BIC-like model using `mfp`.
    * Prints the `mfp` model summaries (fptable, coefficients).
    * Detaches `mfp`.
    * Fits an AIC-like and BIC-like model using `mfp2` on the same subset.
    * Prints the `mfp2` model summaries.
* **Outputs Saved**:
    * This script primarily prints comparison output directly to the R console. It does not save specific summary files in its current form.

### (Auxiliary Script: `new analysis mfp2.R`)

* **Purpose**: Similar to `MFP2 analysis on same data as MFP.R`, but it **recreates** the data subsets from the original `dat_ida.csv` rather than loading the `.rds` file. This makes it independent of the `mfp` script run but means it doesn't use the identical sampled data for comparison.
* **Outputs Saved**:
    * `dat_subsets_list_for_mfp2.rds`: An R data file containing the list of recreated data subsets.
    * `mfp2_aic_fp_powers_summary.csv`: Summary of selected FP powers/DF for AIC models.
    * `mfp2_aic_categorical_selection_summary.csv`: Summary of selected categorical variables for AIC models.
    * `mfp2_bic_fp_powers_summary.csv`: Summary of selected FP powers/DF for BIC models.
    * `mfp2_bic_categorical_selection_summary.csv`: Summary of selected categorical variables for BIC models.

## Workflow

1.  Ensure the main dataset exists at `data/dat_ida.csv`.
2.  Run `New analysis mfp.R` first. This will perform the `mfp` analysis and generate the essential `dat_subsets_list.rds`.
3.  Run `MFP2 analysis on same data as MFP.R`. This will use the `.rds` file from step 2 to run the `mfp2` analysis on identical data.
4.  Examine the resulting `.csv` summary files from both scripts to compare selected terms and powers across different sample sizes and selection criteria.
5.  Run `Compare mfp vs mfp2.R` to see a direct console output comparison for a single subset.

## Future Work

While the current scripts compare the selected terms and powers, further analysis could involve:

* **Comparing Model Fits**: Evaluate goodness-of-fit statistics (e.g., likelihood, AIC/BIC values if directly comparable) between the final models selected by `mfp` and `mfp2` for each subset.
* **Comparing Predictions**: Generate predictions (e.g., linear predictors, risk scores) on a hold-out dataset or using cross-validation based on the models fitted by each package. Compare the correlation and agreement (e.g., using Bland-Altman plots) of these predictions.
* **Comparing Functional Forms**: For continuous variables selected for non-linear transformation (FP terms), plot the estimated functional forms (log relative hazard vs. variable value) derived from both `mfp` and `mfp2` models side-by-side to visually assess similarities or differences.

